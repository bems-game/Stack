<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Stack Tower (Mobile Friendly)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial Black', Gadget, sans-serif; }
        canvas { display: block; }
        .ui-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            color: white;
            text-shadow: 0 0 10px #000;
        }
        #start-screen { background-color: rgba(0,0,0,0.5); z-index: 10; }
        #game-over-screen { background-color: rgba(0,0,0,0.8); display: none; z-index: 10;}
        h1 { font-size: 3rem; }
        p { font-size: 1.2rem; }
        button {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        button:hover { background-color: #e67e22; }
        #score-container {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: white;
            pointer-events: none;
        }
        #score {
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        #high-score {
            font-size: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="score-container">
        <div id="score">0</div>
        <div id="high-score">High Score: 0</div>
    </div>
    <div id="start-screen" class="ui-overlay">
        <h1>3D Stack Tower</h1>
        <p>Ketuk layar untuk menumpuk balok setinggi mungkin!</p>
        <button id="start-button">Mulai</button>
    </div>
    <div id="game-over-screen" class="ui-overlay">
        <h1>GAME OVER</h1>
        <p>Skor Akhir: <span id="final-score">0</span></p>
        <button id="restart-button">Mulai Lagi</button>
    </div>
    <script>
        // --- BASIC SETUP ---
        let scene, camera, renderer;
        let sfx, music;
        let stack = [];
        let overhangs = [];
        const boxHeight = 1;
        let gameState = 'loading'; // loading, ready, playing, gameOver

        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreElement = document.getElementById('final-score');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        let highScore = localStorage.getItem('stackHighScore') || 0;

        init();
        animate();

        function init() {
            gameState = 'loading';
            if (scene) {
                while(scene.children.length > 0){
                    scene.remove(scene.children[0]);
                }
            }
            stack = [];
            overhangs = [];
            scoreElement.innerText = 0;
            highScoreElement.innerText = `High Score: ${highScore}`;

            scene = new THREE.Scene();

            addLayer(0, 0, 10, 10, 'x');
            addLayer(-15, 0, 10, 10, 'z');

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(10, 20, 0);
            scene.add(dirLight);

            const aspect = window.innerWidth / window.innerHeight;
            const d = 20;
            camera = new THREE.OrthographicCamera(-d * aspect / 2, d * aspect / 2, d / 2, -d / 2, 1, 1000);

            camera.position.set(10, 8, 10);
            camera.lookAt(0, 0, 0);

            if (!renderer) {
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);
            }
            
            gameState = 'ready';
        }

        function initAudio() {
             if (sfx) return;
             sfx = {
                 place: new Tone.Synth({oscillator: {type: 'sine'}, envelope: {attack: 0.005, decay: 0.2, sustain: 0, release: 0.2}}).toDestination(),
                 gameOver: new Tone.Synth().toDestination()
             };
            
             music = new Tone.Synth({
                 oscillator: { type: "fmsine", modulationType: "sine", modulationIndex: 3, harmonicity: 3.4 },
                 envelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 2 }
             }).toDestination();
             music.volume.value = -15;
            
             const musicPattern = new Tone.Sequence((time, note) => {
                 music.triggerAttackRelease(note, "8n", time);
             }, ["C4", "E4", "G4", "B4"], "2n");
            
             musicPattern.start(0);
             Tone.Transport.bpm.value = 120;
        }
        
        // PENYESUAIAN MOBILE: Fungsi untuk memulai game
        function startGame() {
            if (gameState !== 'ready') return;
            
            if(Tone.context.state !== 'running') Tone.start();
            initAudio();
            Tone.Transport.start();
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            gameState = 'playing';
        }

        function addLayer(x, z, width, depth, direction) {
            const y = boxHeight * stack.length;
            const layer = generateBox(x, y, z, width, depth);
            layer.direction = direction;
            stack.push(layer);
        }

        function addOverhang(x, z, width, depth) {
            const y = boxHeight * (stack.length - 1);
            const overhang = generateBox(x, y, z, width, depth);
            overhangs.push(overhang);
        }

        function generateBox(x, y, z, width, depth) {
            const geometry = new THREE.BoxGeometry(width, boxHeight, depth);
            const color = new THREE.Color(`hsl(${30 + stack.length * 4}, 100%, 50%)`);
            const material = new THREE.MeshLambertMaterial({ color });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            scene.add(mesh);
            return { threejs: mesh, width, depth };
        }
        
        // PENYESUAIAN MOBILE: Fungsi untuk menempatkan balok
        function placeBlock() {
            if (gameState !== 'playing') return;

            sfx.place.triggerAttackRelease("C4", "8n");
            const topLayer = stack[stack.length - 1];
            const prevLayer = stack[stack.length - 2];
            const direction = topLayer.direction;

            const delta = topLayer.threejs.position[direction] - prevLayer.threejs.position[direction];
            const overhangSize = Math.abs(delta);
            const size = direction === 'x' ? topLayer.width : topLayer.depth;
            const overlap = size - overhangSize;

            if (overlap > 0) {
                const newWidth = direction === 'x' ? overlap : topLayer.width;
                const newDepth = direction === 'z' ? overlap : topLayer.depth;

                topLayer.width = newWidth;
                topLayer.depth = newDepth;
                topLayer.threejs.scale[direction] = overlap / size;
                topLayer.threejs.position[direction] -= delta / 2;

                const overhangShift = (overlap / 2 + overhangSize / 2) * Math.sign(delta);
                const overhangX = direction === 'x' ? topLayer.threejs.position.x + overhangShift : topLayer.threejs.position.x;
                const overhangZ = direction === 'z' ? topLayer.threejs.position.z + overhangShift : topLayer.threejs.position.z;
                const overhangWidth = direction === 'x' ? overhangSize : newWidth;
                const overhangDepth = direction === 'z' ? overhangSize : newDepth;
                addOverhang(overhangX, overhangZ, overhangWidth, overhangDepth);

                const nextX = direction === 'x' ? topLayer.threejs.position.x : -15;
                const nextZ = direction === 'z' ? topLayer.threejs.position.z : -15;
                const nextDirection = direction === 'x' ? 'z' : 'x';
                const currentScore = stack.length - 1;
                scoreElement.innerText = currentScore;
                if (currentScore > highScore) {
                    highScore = currentScore;
                    localStorage.setItem('stackHighScore', highScore);
                    highScoreElement.innerText = `High Score: ${highScore}`;
                }
                addLayer(nextX, nextZ, newWidth, newDepth, nextDirection);
            } else {
                sfx.gameOver.triggerAttackRelease("C3", "4n");
                Tone.Transport.stop();
                gameState = 'gameOver';
                finalScoreElement.innerText = stack.length - 1;
                gameOverScreen.style.display = 'flex';
                const topMesh = topLayer.threejs;
                addOverhang(topMesh.position.x, topMesh.position.z, topLayer.width, topLayer.depth);
                scene.remove(topMesh);
            }
        }
        
        // PENYESUAIAN MOBILE: Event listener dipisahkan untuk kejelasan
        startButton.addEventListener('click', startGame);
        
        // Gunakan 'touchstart' untuk input dalam game yang lebih responsif di mobile
        window.addEventListener('touchstart', placeBlock);

        restartButton.addEventListener('click', () => {
            init();
            startGame(); // Langsung mulai game lagi
        });

        function animate() {
            requestAnimationFrame(animate);

            if (gameState === 'playing') {
                const topLayer = stack[stack.length - 1];
                let speed = 0.15 + (stack.length * 0.005); // Kecepatan bertambah
                speed = Math.min(speed, 0.4); // Batasi kecepatan maksimum

                topLayer.threejs.position[topLayer.direction] += speed;
                if (topLayer.threejs.position[topLayer.direction] > 15) {
                    topLayer.threejs.position[topLayer.direction] = -15;
                }
                
                if(camera.position.y < boxHeight * stack.length + 4) {
                    camera.position.y += speed / 3;
                }
            }
            
            overhangs.forEach(overhang => {
                overhang.threejs.position.y -= 0.3;
            });

            // Hapus overhang yang sudah jatuh jauh
            overhangs = overhangs.filter(overhang => {
                if (overhang.threejs.position.y < -20) {
                    scene.remove(overhang.threejs);
                    return false;
                }
                return true;
            });

            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            const d = 20;
            camera.left = -d * aspect / 2;
            camera.right = d * aspect / 2;
            camera.top = d / 2;
            camera.bottom = -d / 2;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
